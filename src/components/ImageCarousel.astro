---
import CarouselDots from './CarouselDots.astro';
import CarouselSlide from './CarouselSlide.astro';

export interface Props {
  image_list: { image: ImageMetadata; alt_text: string }[];
}

const { image_list } = Astro.props;
---

<!-- Image Carousel -->
<div class="carousel-container relative max-w-4xl mx-auto mb-8">
  <div class="carousel-wrapper overflow-hidden rounded-2xl shadow-md">
    <div class="carousel-track flex transition-transform duration-300 ease-in-out">
      {image_list.map((item) => <CarouselSlide source={item.image} alt_text={item.alt_text} />)}
    </div>
  </div>

  <!-- Navigation Buttons -->
  <button
    class="carousel-btn carousel-prev absolute left-2 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-30 text-white p-2 rounded-full hover:bg-opacity-75 transition-opacity"
  >
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"
      ></path>
    </svg>
  </button>

  <button
    class="carousel-btn carousel-next absolute right-2 top-1/2 transform -translate-y-1/2 bg-black bg-opacity-30 text-white p-2 rounded-full hover:bg-opacity-75 transition-opacity"
  >
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
    </svg>
  </button>

  <!-- Dots Indicator -->
  <CarouselDots count={image_list.length} />
</div>

<script>
  import GLightbox from 'glightbox';
  import 'glightbox/dist/css/glightbox.min.css';

  // Initialize GLightbox
  const lightbox = GLightbox({
    touchNavigation: true,
    loop: true,
    autoplayVideos: false,
  });

  // Carousel functionality
  let currentSlide = 0;
  const slides = document.querySelectorAll('.carousel-slide');
  const dots = document.querySelectorAll<HTMLButtonElement>('.dot');
  const track = document.querySelector<HTMLDivElement>('.carousel-track');
  const prevBtn = document.querySelector<HTMLButtonElement>('.carousel-prev');
  const nextBtn = document.querySelector<HTMLButtonElement>('.carousel-next');

  function updateCarousel() {
    if (track) {
      track.style.transform = `translateX(-${currentSlide * 100}%)`;
    }

    // Update dots
    dots.forEach((dot, index) => {
      dot.classList.toggle('bg-gray-800', index === currentSlide);
      dot.classList.toggle('bg-gray-400', index !== currentSlide);
    });
  }

  function nextSlide() {
    currentSlide = (currentSlide + 1) % slides.length;
    updateCarousel();
  }

  function prevSlide() {
    currentSlide = (currentSlide - 1 + slides.length) % slides.length;
    updateCarousel();
  }

  // Event listeners
  if (nextBtn) nextBtn.addEventListener('click', nextSlide);
  if (prevBtn) prevBtn.addEventListener('click', prevSlide);

  // Dot navigation
  dots.forEach((dot, index) => {
    dot.addEventListener('click', () => {
      currentSlide = index;
      updateCarousel();
    });
  });

  // Touch/swipe support
  let startX = 0;
  let isDragging = false;

  if (track) {
    track.addEventListener('touchstart', (e: TouchEvent) => {
      startX = e.touches[0].clientX;
      isDragging = true;
    });

    track.addEventListener('touchmove', (e: TouchEvent) => {
      if (!isDragging) return;
      e.preventDefault();
    });

    track.addEventListener('touchend', (e: TouchEvent) => {
      if (!isDragging) return;
      isDragging = false;

      const endX = e.changedTouches[0].clientX;
      const diff = startX - endX;

      if (Math.abs(diff) > 50) {
        if (diff > 0) {
          nextSlide();
        } else {
          prevSlide();
        }
      }
    });
  }

  // Initialize
  updateCarousel();
</script>
